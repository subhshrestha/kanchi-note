name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libkeybinder-3.0-dev \
            libayatana-appindicator3-dev libspeechd-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Generate Drift code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Linux
        run: flutter build linux --release

      - name: Create .deb package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          # If VERSION doesn't start with a digit, use default
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="1.0.0-dev"
          fi

          mkdir -p dist/deb/kanchi-note_${VERSION}/DEBIAN
          mkdir -p dist/deb/kanchi-note_${VERSION}/usr/bin
          mkdir -p dist/deb/kanchi-note_${VERSION}/usr/share/kanchi-note
          mkdir -p dist/deb/kanchi-note_${VERSION}/usr/share/applications
          mkdir -p dist/deb/kanchi-note_${VERSION}/usr/share/icons/hicolor/256x256/apps

          # Copy built files
          cp -r build/linux/x64/release/bundle/* dist/deb/kanchi-note_${VERSION}/usr/share/kanchi-note/

          # Create control file
          cat > dist/deb/kanchi-note_${VERSION}/DEBIAN/control << EOF
          Package: kanchi-note
          Version: ${VERSION}
          Section: education
          Priority: optional
          Architecture: amd64
          Depends: libgtk-3-0, libkeybinder-3.0-0, libayatana-appindicator3-1, speech-dispatcher
          Maintainer: San <san@example.com>
          Description: Danish vocabulary and phrase dictionary
           Kanchi Note is a desktop application for learning Danish vocabulary.
           Features include phrase management, auto-translation, and text-to-speech.
          EOF

          # Create launcher script
          cat > dist/deb/kanchi-note_${VERSION}/usr/bin/kanchi-note << 'EOF'
          #!/bin/bash
          exec /usr/share/kanchi-note/kanchi_note "$@"
          EOF

          chmod +x dist/deb/kanchi-note_${VERSION}/usr/bin/kanchi-note
          chmod +x dist/deb/kanchi-note_${VERSION}/usr/share/kanchi-note/kanchi_note

          # Create desktop entry
          cat > dist/deb/kanchi-note_${VERSION}/usr/share/applications/kanchi-note.desktop << EOF
          [Desktop Entry]
          Name=Kanchi Note
          Comment=Danish vocabulary and phrase dictionary
          Exec=/usr/bin/kanchi-note
          Icon=kanchi-note
          Terminal=false
          Type=Application
          Categories=Education;Languages;
          Keywords=danish;vocabulary;phrases;language;learning;
          EOF

          # Copy icon
          cp assets/app_icon.png dist/deb/kanchi-note_${VERSION}/usr/share/icons/hicolor/256x256/apps/kanchi-note.png

          # Build .deb package
          dpkg-deb --build dist/deb/kanchi-note_${VERSION} dist/kanchi-note_${VERSION}_amd64.deb

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: dist/*.deb
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Generate Drift code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build macOS
        run: flutter build macos --release

      - name: Create DMG
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          # If VERSION doesn't start with a digit, use default
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="1.0.0-dev"
          fi

          mkdir -p dist

          APP_NAME="kanchi_note"
          DMG_NAME="kanchi-note_${VERSION}_macos"
          APP_PATH="build/macos/Build/Products/Release/${APP_NAME}.app"

          # Create temporary directory for DMG contents
          mkdir -p dist/dmg_temp
          cp -r "${APP_PATH}" dist/dmg_temp/

          # Create a symlink to Applications folder
          ln -s /Applications dist/dmg_temp/Applications

          # Create DMG
          hdiutil create -volname "Kanchi Note" -srcfolder dist/dmg_temp -ov -format UDZO "dist/${DMG_NAME}.dmg"

          # Cleanup
          rm -rf dist/dmg_temp

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg
          retention-days: 30

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-deb
          path: dist/

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.deb
            dist/*.dmg
          body: |
            ## Downloads
            - **Linux (Debian/Ubuntu)**: Download the `.deb` file
            - **macOS**: Download the `.dmg` file

            ## Installation

            ### Linux
            ```bash
            sudo dpkg -i kanchi-note_*_amd64.deb
            ```

            ### macOS
            1. Download the `.dmg` file
            2. Open it and drag Kanchi Note to Applications

            ## Requirements
            - **Linux**: GTK3, keybinder, appindicator, speech-dispatcher
            - **macOS**: macOS 10.14 or later
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
